<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tube Panic - Final Fix</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-main: #0f0f0f;
            --text-sub: #606060;
            --accent-color: #ff0000;
            --border-color: #e5e5e5;
            --header-bg: #ffffff;
            --hover-bg: #f2f2f2;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: Roboto, Arial, sans-serif;
            overflow: hidden;
            width: 100%;
            height: 100dvh;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        #app-header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .logo-area { display: flex; align-items: center; font-weight: bold; font-size: 1.1rem; flex: 1; letter-spacing: -0.5px; }
        #logo-icon { color: var(--accent-color); margin-right: 5px; font-size: 24px; }

        .score-area {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1;
        }
        .score-label { font-size: 8px; color: var(--text-sub); font-weight: bold; }
        #score { font-size: 20px; font-weight: 900; color: var(--text-main); }
        #best-score-display { font-size: 10px; color: #aaa; margin-top: 2px; font-weight: bold; }

        #life-display { font-size: 14px; letter-spacing: 2px; flex: 1; text-align: right; }

        /* --- å‹•ç”»ã‚¨ãƒªã‚¢ --- */
        #video-container {
            width: 100%; height: 240px; background: #000;
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden; flex-shrink: 0;
        }
        #video-thumbnail { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .loading-spinner {
            position: absolute; width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff;
            animation: spin 1s ease-in-out infinite; z-index: 10;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #video-ui-overlay {
            position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
            background: rgba(255,255,255,0.3); z-index: 20;
        }
        #seek-bar { width: 45%; height: 100%; background: var(--accent-color); }

        /* --- æƒ…å ±ã‚¨ãƒªã‚¢ --- */
        #info-area {
            flex-grow: 1; overflow-y: auto; background: var(--bg-color);
            padding: 15px; position: relative;
        }
        .video-title { font-size: 18px; margin-bottom: 8px; line-height: 1.4; font-weight: 600; color: var(--text-main);}
        .video-meta { font-size: 12px; color: var(--text-sub); margin-bottom: 15px; }
        .action-bar {
            display: flex; justify-content: space-around;
            padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;
        }
        .action-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; color: var(--text-main); gap: 6px; cursor: pointer; }
        .action-icon { font-size: 20px; background: var(--hover-bg); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;}
        
        .comment-header { font-weight: bold; margin-bottom: 15px; font-size: 14px; color: var(--text-main); }
        .comment { display: flex; gap: 12px; margin-bottom: 20px; font-size: 13px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #ddd; flex-shrink: 0; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .comment-body { display: flex; flex-direction: column; gap: 4px; }
        .user-name { font-size: 11px; color: var(--text-sub); font-weight: bold; }
        .comment-text { color: var(--text-main); line-height: 1.3; }

        /* --- ã‚²ãƒ¼ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ --- */
        #game-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000; overflow: hidden;
        }

        /* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã¦å¯¾ç­–) --- */
        .tp-item {
            position: absolute; background: #fff; color: #000;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            pointer-events: auto; display: flex; flex-direction: column;
            overflow: hidden; border-radius: 8px; border: 1px solid #ddd;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* å‹•ã */
        .move-float { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translate(0,0);} 50%{transform:translate(0, 30px);} }
        .move-shake { animation: vibrate 0.15s linear infinite; }
        @keyframes vibrate { 0%{transform:translate(0,0);} 25%{transform:translate(3px,3px);} 50%{transform:translate(-3px,3px);} 75%{transform:translate(3px,-3px);} 100%{transform:translate(0,0);} }
        .move-orbit { animation: orbit 4s linear infinite; }
        @keyframes orbit { 0%{transform:translate(0,0);} 25%{transform:translate(20px,20px);} 50%{transform:translate(0,40px);} 75%{transform:translate(-20px,20px);} 100%{transform:translate(0,0);} }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */
        .close-btn {
            position: absolute; top: 0; right: 0;
            width: 40px; height: 40px;
            background: transparent; color: #999;
            display: flex; align-items: flex-start; justify-content: flex-end;
            padding: 5px; box-sizing: border-box;
            cursor: pointer; z-index: 9999; 
            font-size: 24px; font-weight: bold; line-height: 1;
        }
        .close-btn::after { content: 'Ã—'; }
        .close-btn:active { color: #f00; transform: scale(1.2); }

        /* ã‚¿ã‚¤ãƒ—åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« (åå‰ã‚’éš è”½) */
        .tp-banner { width: 300px; height: 80px; background: #fff; display: flex; align-items: center; padding: 10px; box-sizing: border-box; border: 1px solid #eee;}
        .tp-banner img { width: 60px; height: 60px; object-fit: cover; margin-right: 12px; border-radius: 6px; }
        
        .tp-square { width: 260px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .tp-square img { width: 100%; height: 140px; object-fit: cover; }
        
        .tp-modal { width: 280px; background: #fff; color: #333; border: 2px solid gold; text-align: center; padding: 25px; border-radius: 16px; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .tp-tag { position: absolute; top: 0; left: 0; background: #f1c40f; color: #000; font-size: 10px; padding: 2px 6px; font-weight: bold; z-index: 5; pointer-events: none; border-bottom-right-radius: 4px; }

        /* FAB (ãƒœãƒ ) */
        #bomb-fab {
            position: fixed; bottom: 30px; right: 20px;
            width: 72px; height: 72px; border-radius: 50%;
            background: #f2f2f2; color: #aaa; border: 1px solid #ddd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 11px; transition: all 0.3s;
            pointer-events: auto;
        }
        #bomb-fab.ready {
            background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; cursor: pointer; border: none;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4); animation: pulseBtn 1s infinite;
        }
        @keyframes pulseBtn { 0%{transform:scale(1);} 50%{transform:scale(1.08);} 100%{transform:scale(1);} }
        #bomb-icon { font-size: 26px; margin-bottom: 2px; }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.92); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #333; text-align: center; padding: 20px;
        }
        .btn-start {
            background: var(--text-main); color: white; border: none;
            padding: 15px 50px; font-size: 20px; border-radius: 30px;
            font-weight: bold; margin-top: 30px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .hidden { display: none !important; }

        .click-fail { animation: shake 0.3s; border: 3px solid red !important; }
        .flash-screen { animation: flash 0.5s; position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9000; pointer-events:none; }
        @keyframes flash { 0%{opacity:1;} 100%{opacity:0;} }

        .new-record { color: #f1c40f; font-weight: bold; animation: pulseText 0.5s infinite alternate; }
        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.1); } }

    </style>
</head>
<body>

    <header id="app-header">
        <div class="logo-area"><span id="logo-icon">â–¶</span> TubePanic</div>
        <div class="score-area">
            <span class="score-label">BLOCKED</span>
            <span id="score">0</span>
            <span id="best-score-display">BEST: 0</span>
        </div>
        <div id="life-display">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
    </header>

    <div id="video-container">
        <img id="video-thumbnail" src="https://picsum.photos/800/450?grayscale" alt="thumb">
        <div class="loading-spinner"></div>
        <div id="video-ui-overlay"><div id="seek-bar"></div></div>
    </div>

    <div id="info-area">
        <div class="video-title">ã€é–²è¦§æ³¨æ„ã€‘åºƒå‘Šã®é‡ãŒå¤šã™ãã¦ã‚¹ãƒãƒ›ãŒç†±ããªã£ãŸä»¶ã«ã¤ã„ã¦ (çµ¶å¯¾ã«æŠ¼ã™ãªï¼)</div>
        <div class="video-meta">250ä¸‡ å›è¦–è´ â€¢ 2025/11/20</div>
        
        <div class="action-bar">
            <div class="action-item"><span class="action-icon">ğŸ‘</span>12ä¸‡</div>
            <div class="action-item"><span class="action-icon">ğŸ‘</span>ä½è©•ä¾¡</div>
            <div class="action-item"><span class="action-icon">â†—ï¸</span>å…±æœ‰</div>
            <div class="action-item"><span class="action-icon">â¬‡ï¸</span>ä¿å­˜</div>
        </div>

        <div class="comment-header">ã‚³ãƒ¡ãƒ³ãƒˆ 1,240ä»¶</div>
        <div class="comment-section" id="comment-list"></div>
        
        <div style="margin-top:30px; border-top:1px solid var(--border-color); padding-top:15px;">
            <div class="comment-header">æ¬¡ã®å‹•ç”»</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="width:140px; height:80px; background:#ddd; flex-shrink:0; border-radius:8px; overflow:hidden;">
                    <img src="https://picsum.photos/200/120?random=99" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div>
                    <div style="font-size:14px; line-height:1.4; margin-bottom:4px; font-weight:500; color:var(--text-main);">çµ¶å¯¾ã«ç¬‘ã£ã¦ã¯ã„ã‘ãªã„åºƒå‘Šé¸æ‰‹æ¨©</div>
                    <div style="font-size:12px; color:var(--text-sub);">Tanaka Games<br>50ä¸‡ å›è¦–è´</div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-layer"></div>
    
    <button id="bomb-fab" onclick="useBomb()">
        <span id="bomb-icon">ğŸ’£</span>
        <span id="bomb-text">0%</span>
    </button>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="overlay">
        <h1 style="color: var(--accent-color); font-size: 3rem; margin: 0; letter-spacing: -2px;">Tube Panic</h1>
        <p style="color: var(--text-sub); font-weight: bold;">Score Attack Edition</p>
        
        <div style="margin: 10px 0; font-size: 16px; font-weight: bold; color: var(--text-main);">
            ğŸ† BEST: <span id="start-best">0</span>
        </div>
        
        <div style="text-align:left; background: #fff; padding:20px; border-radius:12px; margin-top:20px; font-size:13px; max-width: 320px; line-height: 1.6; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <p style="margin-bottom:10px; font-size:16px; border-bottom:1px solid #eee; padding-bottom:5px; text-align:center; color:var(--text-main);"><b>ğŸ® éŠã³æ–¹</b></p>
            <p>ğŸ‘† <b>åºƒå‘Šã‚’é–‰ã˜ã‚‹</b>ï¼šÃ—ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼</p>
            <p>â¤ï¸ <b>ãƒ©ã‚¤ãƒ•</b>ï¼šèª¤ã‚¿ãƒƒãƒ—5å›ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚</p>
            <p>â˜ ï¸ <b>åŸ‹æ²¡</b>ï¼šç”»é¢ãŒåŸ‹ã‚å°½ãã•ã‚Œã¦ã‚‚çµ‚äº†ã€‚</p>
            <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-top:10px; display:flex; align-items:center; gap:10px; border:1px solid #eee;">
                <div style="font-size:24px;">ğŸ’£</div>
                <div>
                    <b>å¿…æ®ºæŠ€ (å³ä¸‹)</b><br>
                    <span style="color:#888;">100%ã§ç™ºå‹•å¯ã€‚<b style="color:#0072ff;">å…¨æ¶ˆå»ï¼</b></span>
                </div>
            </div>
        </div>
        
        <button class="btn-start" onclick="startGame()">å†ç”Ÿ (Play)</button>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
    <div id="game-over-screen" class="overlay hidden">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸ’€</div>
        <h2 id="go-title" style="color:var(--text-main);">Playback Error</h2>
        <p id="go-reason" style="color:var(--text-sub);">System crashed.</p>
        
        <div style="margin: 30px 0; text-align: center;">
            <p style="font-size: 14px; color: var(--text-sub); margin-bottom: 5px; font-weight:bold; letter-spacing:1px;">TOTAL BLOCKED</p>
            <div style="font-size: 70px; font-weight: 900; color: var(--text-main); line-height: 1; letter-spacing:-3px;">
                <span id="final-score">0</span>
            </div>
            <div style="margin-top: 10px; font-size: 16px; font-weight: bold; color: var(--text-sub);">
                BEST: <span id="final-best">0</span>
                <span id="new-record-label" class="new-record hidden" style="margin-left:10px;">NEW RECORD!</span>
            </div>
        </div>
        
        <button class="btn-start" onclick="startGame()">å†æŒ‘æˆ¦</button>
    </div>

    <script>
        // ãƒã‚¤ã‚¹ã‚³ã‚¢ç®¡ç† (å®‰å…¨ç­–è¿½åŠ )
        const HIGH_SCORE_KEY = 'tubePanicHighScore';
        let highScore = 0;
        
        // èµ·å‹•æ™‚ã®localStorageã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«try-catchã‚’è¿½åŠ 
        try {
            highScore = localStorage.getItem(HIGH_SCORE_KEY) || 0;
        } catch (e) {
            console.warn('LocalStorage not available');
        }

        // UIã¸ã®åæ˜  (DOMãŒã¾ã ç„¡ã„å ´åˆã®ã‚¨ãƒ©ãƒ¼é˜²æ­¢)
        window.addEventListener('DOMContentLoaded', () => {
            const startBestEl = document.getElementById('start-best');
            if(startBestEl) startBestEl.innerText = highScore;
            
            const bestScoreDisp = document.getElementById('best-score-display');
            if(bestScoreDisp) bestScoreDisp.innerText = `BEST: ${highScore}`;
        });

        const comments = [
            { user: "User123", text: "åºƒå‘Šå¤šã™ãã¦è‰", img: 101 },
            { user: "GamerX", text: "100å€‹è¶…ãˆã‚‹ã¨åœ°ç„", img: 102 },
            { user: "AdHater", text: "Ã—ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹...è¦‹ãˆã‚‹ãï¼", img: 103 },
            { user: "NoobPlayer", text: "éŸ³é‡æ³¨æ„", img: 104 }
        ];

        const adsData = [
            { type: 'banner', title: 'æ¿€ãƒ¤ã‚»ç¿’æ…£', desc: '1æ—¥1å›é£²ã‚€ã ã‘', btn:'è©³ç´°' },
            { type: 'banner', title: 'ç‹é“RPG', desc: 'ä»Šãªã‚‰ã‚¬ãƒãƒ£100é€£', btn:'DL' },
            { type: 'square', title: 'ã€è¡æ’ƒã€‘', desc: 'ã“ã®ã‚ã¨ä¿¡ã˜ã‚‰ã‚Œãªã„çµæœ«ãŒï¼', btn:'è¦‹ã‚‹' },
            { type: 'square', title: 'æŠ•è³‡ã®ç¥æ§˜', desc: 'å…ƒæ‰‹ã‚¼ãƒ­ã‹ã‚‰1å„„ç¨¼ã', btn:'ç™»éŒ²' },
            { type: 'modal', title: 'WARNING', desc: 'System is overheating!', btn:'FIX' }
        ];

        let state = {
            isPlaying: false,
            score: 0,
            life: 5,
            bombGauge: 0,
            maxBomb: 20,
            spawnRate: 1000,
            loopId: null
        };

        let gameLayer, scoreEl, lifeEl, bombBtn, bombText, videoThumbnail, commentList;

        // DOMè¦ç´ ã®å–å¾—ã‚‚DOMContentLoadedå†…ã§è¡Œã†
        window.addEventListener('DOMContentLoaded', () => {
            gameLayer = document.getElementById('game-layer');
            scoreEl = document.getElementById('score');
            lifeEl = document.getElementById('life-display');
            bombBtn = document.getElementById('bomb-fab');
            bombText = document.getElementById('bomb-text');
            videoThumbnail = document.getElementById('video-thumbnail');
            commentList = document.getElementById('comment-list');

            if(commentList) {
                comments.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'comment';
                    div.innerHTML = `
                        <div class="avatar"><img src="https://picsum.photos/id/${c.img}/50/50"></div>
                        <div class="comment-body">
                            <div class="user-name">${c.user} â€¢ 1æ™‚é–“å‰</div>
                            <div class="comment-text">${c.text}</div>
                        </div>
                    `;
                    commentList.appendChild(div);
                });
            }
        });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;

                if (type === 'spawn') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                    osc.start(now); osc.stop(now+0.1);
                } else if (type === 'close') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                    osc.start(now); osc.stop(now+0.1);
                } else if (type === 'damage') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
                    osc.start(now); osc.stop(now+0.3);
                } else if (type === 'bomb') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(800, now+0.5);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.8);
                    osc.start(now); osc.stop(now+0.8);
                } else if (type === 'newrecord') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(523, now); 
                    osc.frequency.setValueAtTime(659, now+0.1); 
                    osc.frequency.setValueAtTime(784, now+0.2); 
                    osc.frequency.setValueAtTime(1046, now+0.3); 
                    gain.gain.setValueAtTime(0.2, now); 
                    gain.gain.linearRampToValueAtTime(0, now+0.6);
                    osc.start(now); osc.stop(now+0.6);
                }
            } catch(e) {
                console.log("Audio error", e);
            }
        }

        function startGame() {
            state.isPlaying = true;
            state.score = 0;
            state.life = 5;
            state.bombGauge = 0;
            state.spawnRate = 1000;
            
            gameLayer.innerHTML = '';
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('new-record-label').classList.add('hidden');
            videoThumbnail.src = `https://picsum.photos/800/450?random=${Date.now()}`;
            
            updateUI();
            gameLoop();
        }

        function gameLoop() {
            if (!state.isPlaying) return;
            spawnAd();
            const nextTime = Math.max(250, 1000 - (state.score * 15));
            state.loopId = setTimeout(gameLoop, nextTime);
        }

        function spawnAd() {
            if (gameLayer.children.length >= 12) {
                gameOver("MEMORY FULL", "åºƒå‘Šã§åŸ‹ã‚å°½ãã•ã‚Œã¾ã—ãŸ");
                return;
            }

            const data = adsData[Math.floor(Math.random() * adsData.length)];
            const rImg = Math.floor(Math.random() * 50) + 10;
            const imgUrl = `https://picsum.photos/id/${rImg}/200/200`;

            const ad = document.createElement('div');
            
            // å‹•ã
            let moveClass = '';
            if (state.score > 10 && Math.random() < 0.6) {
                const moves = ['move-float', 'move-shake', 'move-orbit'];
                moveClass = moves[Math.floor(Math.random() * moves.length)];
            }

            // â˜…ä¿®æ­£ç‚¹: ã‚¯ãƒ©ã‚¹åã‹ã‚‰ 'ad-' ã‚’å‰Šé™¤ã—ã¦ãƒ–ãƒ­ãƒƒã‚«ãƒ¼å¯¾ç­–
            if (data.type === 'banner') {
                ad.className = `tp-item tp-banner ${moveClass}`;
                ad.innerHTML = `
                    <div class="tp-tag">PR</div>
                    <img src="${imgUrl}">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:12px;">${data.title}</div>
                        <div style="font-size:10px; color:#555;">${data.desc}</div>
                    </div>
                    <div style="background:#007aff; color:white; font-size:10px; padding:3px 8px; border-radius:3px;">${data.btn}</div>
                `;
            } else if (data.type === 'square') {
                ad.className = `tp-item tp-square ${moveClass}`;
                ad.innerHTML = `
                    <div class="tp-tag">VIDEO</div>
                    <img src="${imgUrl}">
                    <div style="padding:10px;">
                        <div style="font-weight:bold; font-size:13px; margin-bottom:5px;">${data.title}</div>
                        <div style="font-size:11px; color:#555;">${data.desc}</div>
                    </div>
                `;
            } else {
                ad.className = `tp-item tp-modal ${moveClass}`;
                ad.innerHTML = `
                    <div style="font-size:18px; font-weight:bold; color:gold; margin-bottom:10px;">${data.title}</div>
                    <div style="font-size:14px; margin-bottom:15px;">${data.desc}</div>
                    <button style="background:white; color:black; border:none; padding:8px 20px; font-weight:bold; border-radius:4px;">${data.btn}</button>
                `;
            }

            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-btn';
            closeBtn.innerText = ''; 
            
            const handleClose = (e) => { e.preventDefault(); e.stopPropagation(); closeAd(ad); };
            closeBtn.addEventListener('mousedown', handleClose);
            closeBtn.addEventListener('touchstart', handleClose, {passive: false});
            ad.appendChild(closeBtn);

            const handleBody = (e) => {
                if (e.target !== closeBtn && !closeBtn.contains(e.target)) {
                    takeDamage(ad);
                }
            };
            ad.addEventListener('click', handleBody);

            if (data.type !== 'modal') {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const left = Math.random() * (w - 300);
                const top = 50 + Math.random() * (h - 250);
                ad.style.left = `${Math.max(10, left)}px`;
                ad.style.top = `${Math.max(60, top)}px`;
            }
            ad.style.zIndex = 1000 + state.score;

            gameLayer.appendChild(ad);
            playSound('spawn');
        }

        function closeAd(el) {
            playSound('close');
            el.remove();
            state.score++;
            if (state.bombGauge < state.maxBomb) state.bombGauge++;
            updateUI();
        }

        function takeDamage(el) {
            playSound('damage');
            state.life--;
            el.classList.add('click-fail');
            setTimeout(() => el.classList.remove('click-fail'), 300);
            updateUI();
            if (state.life <= 0) gameOver("GAME OVER", "èª¤ã‚¿ãƒƒãƒ—ã—ã™ãã§ã™ï¼");
        }

        function useBomb() {
            if (state.bombGauge < state.maxBomb || !state.isPlaying) return;
            playSound('bomb');
            const flash = document.createElement('div');
            flash.className = 'flash-screen';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);

            // ã‚¯ãƒ©ã‚¹åãŒå¤‰ã‚ã£ãŸã®ã§ã‚»ãƒ¬ã‚¯ã‚¿ã‚‚å¤‰æ›´
            const ads = document.querySelectorAll('.tp-item');
            let count = 0;
            ads.forEach(ad => { ad.remove(); count++; });
            state.score += count;
            state.bombGauge = 0;
            
            clearTimeout(state.loopId);
            setTimeout(gameLoop, 2000); 
            updateUI();
        }

        function updateUI() {
            scoreEl.innerText = state.score;
            let hearts = "";
            for(let i=0; i<5; i++) hearts += i < state.life ? "â¤ï¸" : "ğŸ’€";
            lifeEl.innerText = hearts;

            const pct = Math.floor((state.bombGauge / state.maxBomb) * 100);
            if (state.bombGauge >= state.maxBomb) {
                bombBtn.classList.add('ready');
                bombText.innerText = "MAX!";
            } else {
                bombBtn.classList.remove('ready');
                bombText.innerText = `${pct}%`;
            }
        }

        function gameOver(title, reason) {
            state.isPlaying = false;
            clearTimeout(state.loopId);
            document.getElementById('go-title').innerText = title;
            document.getElementById('go-reason').innerText = reason;
            document.getElementById('final-score').innerText = state.score;
            
            // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°åˆ¤å®š
            if (state.score > highScore) {
                highScore = state.score;
                try {
                    localStorage.setItem(HIGH_SCORE_KEY, highScore);
                } catch(e) {}
                document.getElementById('new-record-label').classList.remove('hidden');
                playSound('newrecord');
            }
            document.getElementById('final-best').innerText = highScore;
            document.getElementById('best-score-display').innerText = `BEST: ${highScore}`;
            document.getElementById('start-best').innerText = highScore;

            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
